<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>निजी चैट एप्लिकेशन</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* slategray-200 */
        }
        .chat-container {
            max-width: 768px;
            height: 90vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .message {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .message-sent {
            align-self: flex-end;
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message-received {
            align-self: flex-start;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            border-bottom-left-radius: 4px;
        }
        .sender-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.25rem;
        }
        .chat-input {
            border-top: 1px solid #e5e7eb; /* gray-200 */
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="auth-container" class="p-8 bg-white rounded-xl shadow-lg w-full max-w-sm text-center">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">यूजरनेम दर्ज करें</h1>
        <input type="text" id="username-input" placeholder="अपना यूजरनेम..." class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
        <button id="set-username-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">शुरू करें</button>
    </div>

    <div id="chat-container" class="hidden chat-container bg-white">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center rounded-t-lg">
            <h1 class="text-xl font-semibold">निजी चैट</h1>
            <span id="current-user-id" class="text-sm bg-blue-700 px-3 py-1 rounded-full cursor-pointer hover:bg-blue-800 transition-colors" title="अपना यूजर आईडी कॉपी करने के लिए क्लिक करें">आपका ID: लोडिंग...</span>
        </div>

        <!-- Chat Area -->
        <div class="p-4 bg-gray-50 flex-grow overflow-y-auto rounded-b-lg" id="messages-container">
            <p class="text-center text-gray-400 my-4">किसी से चैट शुरू करने के लिए, उनका यूजर ID दर्ज करें।</p>
        </div>

        <!-- Chat Input -->
        <form id="chat-form" class="bg-white p-4 flex gap-2 border-t border-gray-200 rounded-b-lg">
            <input type="text" id="recipient-id-input" placeholder="दूसरे यूजर का ID..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="button" id="start-chat-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">चैट शुरू करें</button>
        </form>

        <form id="message-form" class="bg-white p-4 flex gap-2 border-t border-gray-200 rounded-b-lg hidden">
            <input type="text" id="message-input" placeholder="एक संदेश लिखें..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">भेजें</button>
        </form>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, serverTimestamp, query, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from user and global variables
        const firebaseConfig = {
            apiKey: "AIzaSyDE8zApy4owfoFlgrbB80LSCEVxRWAvqcc",
            authDomain: "lalitapp-5cdf0.firebaseapp.com",
            databaseURL: "https://lalitapp-5cdf0-default-rtdb.firebaseio.com",
            projectId: "lalitapp-5cdf0",
            storageBucket: "lalitapp-5cdf0.firebasestorage.app",
            messagingSenderId: "296397903515",
            appId: "1:296397903515:web:efe85353eb8f548243d83e"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI elements
        const authContainer = document.getElementById('auth-container');
        const usernameInput = document.getElementById('username-input');
        const setUsernameBtn = document.getElementById('set-username-btn');
        const chatContainer = document.getElementById('chat-container');
        const currentUserIdSpan = document.getElementById('current-user-id');
        const messagesContainer = document.getElementById('messages-container');
        const chatForm = document.getElementById('chat-form');
        const recipientIdInput = document.getElementById('recipient-id-input');
        const startChatBtn = document.getElementById('start-chat-btn');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        let currentUser = null;
        let username = '';
        let recipientId = '';
        let unsubscribeFromChat = null;

        // Function to create a consistent chat ID for two users
        const getChatId = (id1, id2) => {
            return [id1, id2].sort().join('_');
        };

        // Function to set up the user profile in Firestore
        const setupUser = async (userId, userName) => {
            const userRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'info');
            await setDoc(userRef, {
                userId: userId,
                username: userName,
                lastSeen: serverTimestamp()
            }, { merge: true });
        };

        // Function to listen for chat messages
        const listenForMessages = (chatId) => {
            if (unsubscribeFromChat) {
                unsubscribeFromChat();
            }

            const messagesRef = collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            unsubscribeFromChat = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-400 my-4">अभी तक कोई संदेश नहीं। अपना पहला संदेश भेजें।</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const messageData = doc.data();
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message');

                        if (messageData.senderId === currentUser.uid) {
                            messageDiv.classList.add('message-sent');
                        } else {
                            messageDiv.classList.add('message-received');
                            const senderNameSpan = document.createElement('span');
                            senderNameSpan.classList.add('sender-name');
                            senderNameSpan.textContent = messageData.senderName;
                            messageDiv.appendChild(senderNameSpan);
                        }

                        const textP = document.createElement('p');
                        textP.textContent = messageData.text;
                        messageDiv.appendChild(textP);

                        messagesContainer.appendChild(messageDiv);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });
        };

        // Event listener for setting username
        setUsernameBtn.addEventListener('click', async () => {
            const userNameValue = usernameInput.value.trim();
            if (userNameValue) {
                username = userNameValue;
                // Transition UI
                authContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                // The onAuthStateChanged listener will handle the rest
            } else {
                alert('कृपया अपना यूजरनेम दर्ज करें।');
            }
        });

        // Event listener for starting a new chat
        startChatBtn.addEventListener('click', () => {
            const recipientIdValue = recipientIdInput.value.trim();
            if (recipientIdValue && recipientIdValue !== currentUser.uid) {
                recipientId = recipientIdValue;
                const chatId = getChatId(currentUser.uid, recipientId);
                listenForMessages(chatId);

                // Switch UI to show message input
                chatForm.classList.add('hidden');
                messageForm.classList.remove('hidden');
            } else {
                alert('कृपया दूसरे यूजर का सही ID दर्ज करें।');
            }
        });

        // Event listener for sending a message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText && currentUser && recipientId) {
                const chatId = getChatId(currentUser.uid, recipientId);
                const messagesRef = collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);

                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    senderName: username,
                    recipientId: recipientId,
                    text: messageText,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
            }
        });

        // Copy user ID to clipboard
        currentUserIdSpan.addEventListener('click', () => {
            const userIdText = currentUserIdSpan.textContent.replace('आपका ID: ', '');
            navigator.clipboard.writeText(userIdText).then(() => {
                alert('यूजर ID कॉपी हो गया!');
            }).catch(err => {
                console.error('Copy failed', err);
                alert('ID कॉपी करने में विफल रहा।');
            });
        });

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // If a username was set, set up the user profile
                if (username) {
                    await setupUser(currentUser.uid, username);
                }
                currentUserIdSpan.textContent = `आपका ID: ${currentUser.uid}`;
            } else {
                // Initial sign-in
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
        });
    </script>
</body>
</html>
